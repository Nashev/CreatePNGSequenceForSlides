<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link rel="stylesheet" href="https://ssl.gstatic.com/docs/script/css/add-ons1.css">
    <script>
    
      var SlidesToWait = [];
      var Environment;
      
      function MakePng(Index) {
        google.script.run.withSuccessHandler(onSlideSuccess).withFailureHandler(onSlideFailure).withUserObject(Index).internalSavePNGs2_SaveSlide(
          Index, Environment.PresentationName, Environment.PresentationID, Environment.Slides[Index], Environment.FolderName
        );
      }
      
      function onSuccess(Result) {
        Environment = Result;
        document.getElementById('output').innerHTML = s;
        var s = 
          'Slides will be stored at folder <br />' + 
          '<a href="' + Environment.URL + '" target="_blank">' + Environment.FolderName + '</a>.<br />' + 
          'Total count: ' + Environment.Slides.length + ' slides<br />' + 
          '<div id="Status">Left to save ' + Environment.Slides.length + ' slides.</div> <font size="1">';
        document.getElementById('output').innerHTML = s;
        for (var i = 0; i < Environment.Slides.length; i++) {
          s = s + ' [<span id="slide' + i +'">_</span>]';
          SlidesToWait.push(i)
        }
        s = s + '</font>';
        document.getElementById('output').innerHTML = s;
        // запускаем собственно сохранения
        for (var i = 0; i < Environment.Slides.length; i++) {
          MakePng(i)
        }
      }
      
      function onFailure(error) {
        document.getElementById('output').innerHTML = error.message;
      }
      
      function onSlideSuccess(Result) {
        document.getElementById('slide' + Result).innerText = '+';
        document.getElementById('slide' + Result).style="background-color: Lime;"
        SlidesToWait.pop(Result);
        if (SlidesToWait.length == 0) {
          document.getElementById('Status').innerHTML = 'All done.';
        } else {
          document.getElementById('Status').innerHTML = 'Left to save ' + SlidesToWait.length + ' slides.';
        }
      }

      function sleep2(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
      }


      async function Restart(Index) {
        await sleep2(50*1000);
        MakePng(Index);
      }
      
      
      function onSlideFailure(error, Result) {
        var Msg = '' + error;
        if (
           (Msg.indexOf("Insufficient tokens for quota 'ExpensiveReadGroup' and limit 'USER-100s' of service 'slides.googleapis.com' for consumer") !== -1)
            ||
           (Msg.indexOf("DriveApp.") !== -1)
        ) {
          Restart(Result);
        } else {
          document.getElementById('slide' + Result).innerText = 'x';
          document.getElementById('slide' + Result).style="background-color: red;"
          SlidesToWait.pop(Result);
          if (SlidesToWait.length == 0) {
            document.getElementById('Status').innerHTML = 'All done.';
          } else {
            document.getElementById('Status').innerHTML = 'Left to save ' + SlidesToWait.length + ' slides.';
          }
          document.getElementById('output').innerHTML = document.getElementById('output').innerHTML + '<br /><span class="error">Slide ' + Result + ': ' + error.message + '</span>';
        }
      }

      google.script.run.withSuccessHandler(onSuccess).withFailureHandler(onFailure).internalSavePNGs2_GetSlideList();
      
    </script>
  </head>
  <body>
    <div id="output">Starting, please wait...</div>
    <br/>
    <br/>
    <center><input type="button" value="Close" onclick="google.script.host.close()" /></center>
  </body>
</html>


